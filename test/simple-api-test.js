/**
 * Test the simplified API methods
 */

const { DevPortalClient } = require('../dist');

async function main() {
  console.log('üéØ Simple API Test\n');

  try {
    const client = new DevPortalClient('192.168.2.128', 11337);

    // Fetch YouTube config
    const https = require('https');
    const config = await new Promise((resolve, reject) => {
      https.get('https://plugins.grayjay.app/Youtube/YoutubeConfig.json', (res) => {
        let data = '';
        res.on('data', chunk => data += chunk);
        res.on('end', () => resolve(JSON.parse(data)));
      }).on('error', reject);
    });

    console.log(`üì¶ Testing with: ${config.name} v${config.version}\n`);

    // Load portal
    console.log('1Ô∏è‚É£  Loading portal...');
    await client.loadPortal(8000);
    console.log('   ‚úÖ Done\n');

    // Inject plugin
    console.log('2Ô∏è‚É£  Injecting plugin...');
    await client.updateTestPlugin('https://plugins.grayjay.app/Youtube/YoutubeScript.js', config);
    console.log('   ‚úÖ Done\n');

    // Wait for plugin to load
    console.log('‚è≥ Waiting 5 seconds...\n');
    await new Promise(resolve => setTimeout(resolve, 5000));

    // Test with SIMPLE API
    console.log('3Ô∏è‚É£  Testing Simple API...\n');

    console.log('   client.call("enable")');
    const enableResult = await client.call('enable');
    console.log(`   ${enableResult.success ? '‚úÖ' : '‚ùå'} ${enableResult.success ? 'Success' : enableResult.error}`);

    console.log('\n   client.call("getHome")');
    const homeResult = await client.call('getHome');
    console.log(`   ${homeResult.success ? '‚úÖ' : '‚ùå'} ${homeResult.success ? 'Success' : homeResult.error}`);
    if (homeResult.success && homeResult.result) {
      console.log(`   üìä Videos: ${homeResult.result.results?.length || 0}`);
    }

    console.log('\n   client.call("isChannelUrl", "https://youtube.com/@test")');
    const isChannelResult = await client.call('isChannelUrl', 'https://youtube.com/@test');
    console.log(`   ${isChannelResult.success ? '‚úÖ' : '‚ùå'} Result: ${JSON.stringify(isChannelResult.result)}`);

    // Test callRemotely (requires runtime UUID which we don't have easily)
    console.log('\n4Ô∏è‚É£  Testing callRemotely (note: requires runtime UUID)...\n');
    console.log('   ‚ÑπÔ∏è  Runtime UUID is different from config UUID');
    console.log(`   ‚ÑπÔ∏è  Config UUID: ${config.id}`);
    console.log('   ‚ÑπÔ∏è  Runtime UUID is generated by server during load');
    console.log('   ‚ÑπÔ∏è  For most testing, use .call() instead\n');

    console.log('‚ú® Simple API works perfectly!\n');
    console.log('üìù Usage:');
    console.log('   const result = await client.call("methodName", ...args);');
    console.log('   const result = await client.callRemotely(runtimeId, "methodName", ...args);\n');

  } catch (error) {
    console.error('‚ùå Error:', error.message);
    console.error(error.stack);
    process.exit(1);
  }
}

if (require.main === module) {
  main();
}

module.exports = { main };
